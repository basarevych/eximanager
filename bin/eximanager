#!/usr/bin/env node

'use strict'

var argv            = require('minimist')(process.argv.slice(2)),
    ServiceLocator  = require('../src/service-locator.js'),
    Console         = require('../src/console.js'),
    FileManager     = require('../src/file-manager.js'),
    Table           = require('../src/table.js'),
    Init            = require('../src/init.js'),
    Domain          = require('../src/domain.js');

var sl = new ServiceLocator(),
    cons = new Console(sl),
    manager = new FileManager(sl),
    table = new Table(sl),
    init = new Init(sl),
    domain = new Domain(sl);

if (argv['_'].length == 0)
    showUsage();

if (argv['_'].length && argv['_'][0] != 'init' && !sl.has('config')) {
    var rl = cons.getReadline();

    rl.write("\nError:\t\tEximanager is not initialized\n");
    rl.write("\t\tPlease run 'eximanager init' before using\n\n");
    rl.close();

    process.exit(2);
}

switch (argv['_'][0]) {
    case 'help':
        showUsage(argv['_'].length > 1 ? argv['_'][1] : 'help');
        break;

    case 'init':
        var dir = argv['d'] ? argv['d'] : argv['dir'];
        if (!dir)
            showUsage('init');

        init.createConfig(dir);
        break;

    case 'domain-get':
        domain.get(argv['_'].length > 1 ? argv['_'][1] : null);
        break;

    case 'domain-set':
        var name = argv['_'].length > 1 ? argv['_'][1] : null,
            mx = argv['m'] ? argv['m'] : argv['mx'];
        domain.set(name, mx);
        break;

    default:
        var rl = cons.getReadline();
        rl.write("\nError: \t\tUnkown command: " + argv['_'][0] + "\n\n");
        rl.close();
        process.exit(1);
}

function showUsage(command) {
    var rl = cons.getReadline();

    rl.write("\n");
    switch (command) {
        case 'help':
            rl.write("Usage:\teximanager help <command>\n\n");
            rl.write("\tPrint usage info on <command>\n\n");
            rl.write("Note:\tRun eximanager without arguments to get list of commands\n");
            break;

        case 'init':
            rl.write("Usage:\teximanager init -d|--dir <configuration-directory>\n\n");
            rl.write("\tCreate configuration file (eximanager.conf.js)\n");
            rl.write("\t<configuration-directory> is either /etc or /usr/local/etc\n");
            break;

        case 'domain-get':
            rl.write("Usage:\teximanager domain-get [<regexp-filter>]\n\n");
            rl.write("\tPrint defined virtual mail domains\n\n");
            rl.write("\teximanager domain-get '^ex.*com$'\n");
            rl.write("\tWill print all the domains starting with \"ex\" and ending with \"com\"\n");
            break;

        case 'domain-set':
            rl.write("Usage:\teximanager domain-set <name> [-m|--mx <domain-name>]\n\n");
            rl.write("\tCreate/modify virtual main domain\n\n");
            rl.write("\teximanager domain-set example.com --mx mx.example.com\n");
            rl.write("\tWill create domain \"example.com\" (if it does not exist)\n");
            rl.write("\tand set it's MX to \"mx.example.com\"\n");
            break;

        default:
            rl.write("Usage:\t\teximanager <command> [options]\n");
            rl.write("\nCommands:");
            rl.write("\thelp\t\tPrint help screen\n");
            rl.write("\t\tinit\t\tInitialize Eximanager\n");
            rl.write("\t\tdomain-get\tFiltered list of virtual domains\n");
            rl.write("\t\tdomain-set\tCreate or modify virtual domain\n");
            rl.write("\nNote:\t\tRun \"eximanager help <command>\" for help on the command\n");
    }

    rl.write("\n");
    rl.close();

    process.exit(1);
}
